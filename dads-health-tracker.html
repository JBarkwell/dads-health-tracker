<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Dad's Health Tracker</title>
<style>
  :root {
    --primary: #2563eb;
    --primary-light: #dbeafe;
    --success: #16a34a;
    --success-light: #dcfce7;
    --warning: #d97706;
    --warning-light: #fef3c7;
    --danger: #dc2626;
    --danger-light: #fee2e2;
    --purple: #7c3aed;
    --purple-light: #ede9fe;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-500: #6b7280;
    --gray-700: #374151;
    --gray-900: #111827;
    --radius: 12px;
    --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
    --shadow-md: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.06);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--gray-50);
    color: var(--gray-900);
    min-height: 100vh;
    padding-bottom: 80px;
    font-size: 16px;
    line-height: 1.5;
  }

  /* Header */
  .header {
    background: linear-gradient(135deg, var(--primary), #1d4ed8);
    color: white;
    padding: 16px 20px;
    text-align: center;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: var(--shadow-md);
  }
  .header h1 { font-size: 20px; font-weight: 700; }
  .header .date { font-size: 14px; opacity: 0.85; margin-top: 2px; }

  /* Date Selector */
  .date-selector {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: 4px;
  }
  .date-nav-btn {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
    -webkit-tap-highlight-color: transparent;
  }
  .date-nav-btn:hover { background: rgba(255,255,255,0.3); }
  .date-nav-btn:disabled { opacity: 0.3; cursor: default; }
  .date-display {
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    padding: 4px 12px;
    border-radius: 8px;
    background: rgba(255,255,255,0.15);
    position: relative;
  }
  .date-display input[type="date"] {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    opacity: 0;
    cursor: pointer;
    font-size: 16px;
  }
  .past-date-banner {
    background: var(--warning-light);
    border: 1px solid var(--warning);
    color: var(--gray-700);
    text-align: center;
    padding: 6px 12px;
    font-size: 13px;
    font-weight: 500;
  }
  .past-date-banner button {
    background: var(--warning);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 2px 10px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    margin-left: 8px;
  }

  /* Bottom Nav */
  .bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    display: flex;
    border-top: 1px solid var(--gray-200);
    z-index: 100;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
  }
  .nav-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 8px 4px;
    font-size: 10px;
    color: var(--gray-500);
    cursor: pointer;
    border: none;
    background: none;
    transition: color 0.2s;
    -webkit-tap-highlight-color: transparent;
  }
  .nav-item.active { color: var(--primary); font-weight: 600; }
  .nav-item svg { width: 24px; height: 24px; margin-bottom: 2px; }

  /* Pages */
  .page { display: none; padding: 16px; max-width: 600px; margin: 0 auto; }
  .page.active { display: block; }

  /* Cards */
  .card {
    background: white;
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 12px;
    box-shadow: var(--shadow);
  }
  .card h3 { font-size: 16px; margin-bottom: 8px; color: var(--gray-700); }

  /* Progress Ring */
  .progress-container { text-align: center; margin: 16px 0; }
  .progress-ring { position: relative; display: inline-block; }
  .progress-ring svg { transform: rotate(-90deg); }
  .progress-ring .center-text {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
  }
  .progress-ring .amount { font-size: 28px; font-weight: 700; display: block; }
  .progress-ring .label { font-size: 12px; color: var(--gray-500); }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 12px 20px;
    border-radius: var(--radius);
    font-size: 16px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    -webkit-tap-highlight-color: transparent;
    gap: 8px;
  }
  .btn-primary { background: var(--primary); color: white; }
  .btn-primary:hover { background: #1d4ed8; }
  .btn-success { background: var(--success); color: white; }
  .btn-success:hover { background: #15803d; }
  .btn-warning { background: var(--warning); color: white; }
  .btn-danger { background: var(--danger); color: white; }
  .btn-outline {
    background: white;
    color: var(--primary);
    border: 2px solid var(--primary);
  }
  .btn-block { display: flex; width: 100%; }
  .btn-lg { padding: 16px 24px; font-size: 18px; }
  .btn-sm { padding: 8px 14px; font-size: 14px; }

  /* Quick Add Buttons */
  .quick-add-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin: 12px 0;
  }
  .quick-add-btn {
    background: var(--primary-light);
    color: var(--primary);
    border: 2px solid transparent;
    border-radius: var(--radius);
    padding: 12px 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    text-align: center;
    transition: all 0.2s;
  }
  .quick-add-btn:hover, .quick-add-btn:active {
    border-color: var(--primary);
    background: white;
  }

  /* Form Elements */
  .form-group { margin-bottom: 12px; }
  .form-group label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: var(--gray-700);
    margin-bottom: 4px;
  }
  input[type="text"], input[type="number"], input[type="time"], select, textarea {
    width: 100%;
    padding: 12px;
    border: 2px solid var(--gray-200);
    border-radius: var(--radius);
    font-size: 16px;
    font-family: inherit;
    transition: border-color 0.2s;
  }
  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--primary);
  }
  textarea { resize: vertical; min-height: 80px; }

  /* Log entries */
  .log-entry {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid var(--gray-100);
  }
  .log-entry:last-child { border-bottom: none; }
  .log-entry .info { flex: 1; }
  .log-entry .time { font-size: 12px; color: var(--gray-500); }
  .log-entry .detail { font-size: 14px; font-weight: 600; }
  .log-entry .sub { font-size: 12px; color: var(--gray-500); }
  .delete-btn {
    background: none;
    border: none;
    color: var(--gray-300);
    cursor: pointer;
    padding: 4px;
    font-size: 18px;
  }
  .delete-btn:hover { color: var(--danger); }

  /* Exercise items */
  .exercise-item {
    display: flex;
    align-items: center;
    padding: 12px;
    background: var(--gray-50);
    border-radius: var(--radius);
    margin-bottom: 8px;
    gap: 12px;
  }
  .exercise-check {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 2px solid var(--gray-300);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all 0.2s;
    background: white;
  }
  .exercise-check.done {
    background: var(--success);
    border-color: var(--success);
    color: white;
  }
  .exercise-info { flex: 1; }
  .exercise-name { font-weight: 600; font-size: 15px; }
  .exercise-desc { font-size: 12px; color: var(--gray-500); }
  .exercise-item.completed { opacity: 0.6; }
  .exercise-item.completed .exercise-name { text-decoration: line-through; }

  /* Symptom chips */
  .symptom-chips { display: flex; flex-wrap: wrap; gap: 8px; margin: 12px 0; }
  .symptom-chip {
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    cursor: pointer;
    border: 2px solid var(--gray-200);
    background: white;
    transition: all 0.2s;
  }
  .symptom-chip.selected {
    border-color: var(--danger);
    background: var(--danger-light);
    color: var(--danger);
    font-weight: 600;
  }

  /* Severity scale */
  .severity-scale { display: flex; gap: 4px; margin: 8px 0; }
  .severity-btn {
    flex: 1;
    padding: 10px;
    border: 2px solid var(--gray-200);
    background: white;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    text-align: center;
    transition: all 0.2s;
  }
  .severity-btn.selected { color: white; }
  .severity-btn[data-level="1"].selected { background: #22c55e; border-color: #22c55e; }
  .severity-btn[data-level="2"].selected { background: #84cc16; border-color: #84cc16; }
  .severity-btn[data-level="3"].selected { background: #eab308; border-color: #eab308; }
  .severity-btn[data-level="4"].selected { background: #f97316; border-color: #f97316; }
  .severity-btn[data-level="5"].selected { background: #ef4444; border-color: #ef4444; }

  /* Medication item */
  .med-item {
    display: flex;
    align-items: center;
    padding: 12px;
    background: white;
    border-radius: var(--radius);
    margin-bottom: 8px;
    border: 1px solid var(--gray-200);
    gap: 12px;
  }
  .med-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: var(--purple-light);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    flex-shrink: 0;
  }
  .med-info { flex: 1; }
  .med-name { font-weight: 600; }
  .med-dose { font-size: 13px; color: var(--gray-500); }
  .med-take-btn {
    padding: 8px 16px;
    border-radius: 8px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    font-size: 13px;
  }
  .med-take-btn.taken { background: var(--success-light); color: var(--success); }
  .med-take-btn.pending { background: var(--warning-light); color: var(--warning); }

  /* Summary stats */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin: 12px 0;
  }
  .stat-card {
    background: white;
    border-radius: var(--radius);
    padding: 14px;
    text-align: center;
    border: 1px solid var(--gray-200);
  }
  .stat-value { font-size: 24px; font-weight: 700; }
  .stat-label { font-size: 12px; color: var(--gray-500); margin-top: 2px; }

  /* Reminder Banner */
  .reminder-banner {
    background: var(--warning-light);
    border: 1px solid var(--warning);
    border-radius: var(--radius);
    padding: 12px 16px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    animation: pulse 2s infinite;
  }
  .reminder-banner .icon { font-size: 24px; }
  .reminder-banner .text { flex: 1; font-size: 14px; font-weight: 500; }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.85; }
  }

  /* Modal */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 200;
    align-items: flex-end;
    justify-content: center;
  }
  .modal-overlay.active { display: flex; }
  .modal {
    background: white;
    border-radius: 16px 16px 0 0;
    padding: 20px;
    width: 100%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
  }
  .modal h2 { font-size: 18px; margin-bottom: 16px; }
  .modal-close {
    float: right;
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--gray-500);
  }

  /* Toast */
  .toast {
    position: fixed;
    top: 70px;
    left: 50%;
    transform: translateX(-50%) translateY(-100px);
    background: var(--gray-900);
    color: white;
    padding: 10px 16px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 500;
    z-index: 300;
    transition: transform 0.3s ease;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 12px;
    max-width: 92vw;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }
  .toast .toast-msg { flex: 1; }
  .toast .undo-btn {
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 5px 14px;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
    transition: background 0.2s;
  }
  .toast .undo-btn:hover { background: #1d4ed8; }
  .toast .toast-timer {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 3px;
    background: var(--primary);
    border-radius: 0 0 10px 10px;
    transition: width linear;
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 30px 20px;
    color: var(--gray-500);
  }
  .empty-state .icon { font-size: 40px; margin-bottom: 8px; }
  .empty-state p { font-size: 14px; }

  /* Report section */
  .report-section { margin-bottom: 16px; }
  .report-section h4 {
    font-size: 14px;
    color: var(--gray-500);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
    padding-bottom: 4px;
    border-bottom: 1px solid var(--gray-200);
  }

  /* Caregiver badge */
  .caregiver-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 8px;
    font-size: 13px;
    color: var(--gray-500);
  }
  .toggle-switch {
    position: relative;
    width: 44px;
    height: 24px;
    background: var(--gray-300);
    border-radius: 12px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .toggle-switch.on { background: var(--primary); }
  .toggle-switch::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 20px;
    height: 20px;
    background: white;
    border-radius: 50%;
    transition: transform 0.2s;
  }
  .toggle-switch.on::after { transform: translateX(20px); }

  /* Section header */
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }
  .section-title { font-size: 18px; font-weight: 700; }

  /* Meal Timeline */
  .meal-timeline {
    position: relative;
    padding-left: 20px;
    margin: 12px 0 16px;
  }
  .meal-timeline::before {
    content: '';
    position: absolute;
    left: 6px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: var(--gray-200);
  }
  .tl-item {
    position: relative;
    padding: 8px 0 8px 16px;
  }
  .tl-dot {
    position: absolute;
    left: -17px;
    top: 12px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 0 0 2px var(--gray-300);
  }
  .tl-dot.water { background: #3b82f6; box-shadow: 0 0 0 2px #3b82f6; }
  .tl-dot.ice { background: #93c5fd; box-shadow: 0 0 0 2px #93c5fd; }
  .tl-dot.electrolyte { background: #06b6d4; box-shadow: 0 0 0 2px #06b6d4; }
  .tl-dot.iv { background: #8b5cf6; box-shadow: 0 0 0 2px #8b5cf6; }
  .tl-dot.juice { background: #f59e0b; box-shadow: 0 0 0 2px #f59e0b; }
  .tl-dot.tea { background: #84cc16; box-shadow: 0 0 0 2px #84cc16; }
  .tl-dot.otherdrink { background: #6b7280; box-shadow: 0 0 0 2px #6b7280; }
  .tl-type.water { background: #dbeafe; color: #1e40af; }
  .tl-type.ice { background: #e0f2fe; color: #0369a1; }
  .tl-type.electrolyte { background: #cffafe; color: #0e7490; }
  .tl-type.iv { background: #ede9fe; color: #5b21b6; }
  .tl-type.juice { background: #fef3c7; color: #92400e; }
  .tl-type.tea { background: #ecfccb; color: #3f6212; }
  .tl-type.otherdrink { background: #f3f4f6; color: #374151; }
  .tl-dot.breakfast { background: #f59e0b; box-shadow: 0 0 0 2px #f59e0b; }
  .tl-dot.lunch { background: #3b82f6; box-shadow: 0 0 0 2px #3b82f6; }
  .tl-dot.dinner { background: #8b5cf6; box-shadow: 0 0 0 2px #8b5cf6; }
  .tl-dot.snack { background: #10b981; box-shadow: 0 0 0 2px #10b981; }
  .tl-dot.supplement { background: #ec4899; box-shadow: 0 0 0 2px #ec4899; }
  .tl-time { font-size: 11px; color: var(--gray-500); font-weight: 600; }
  .tl-type {
    display: inline-block;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 1px 6px;
    border-radius: 4px;
    margin-left: 6px;
  }
  .tl-type.breakfast { background: #fef3c7; color: #92400e; }
  .tl-type.lunch { background: #dbeafe; color: #1e40af; }
  .tl-type.dinner { background: #ede9fe; color: #5b21b6; }
  .tl-type.snack { background: #d1fae5; color: #065f46; }
  .tl-type.supplement { background: #fce7f3; color: #9d174d; }
  .tl-desc { font-size: 14px; font-weight: 600; margin-top: 2px; }
  .tl-meta { font-size: 12px; color: var(--gray-500); }
  .tl-gap-warning {
    padding: 8px 0 8px 16px;
    position: relative;
  }
  .tl-gap-warning .gap-label {
    font-size: 12px;
    color: var(--warning);
    font-weight: 600;
    font-style: italic;
  }

  /* Custom Time Override */
  .time-override {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: var(--gray-50);
    border: 1px dashed var(--gray-300);
    border-radius: var(--radius);
    margin-bottom: 12px;
    font-size: 13px;
  }
  .time-override.active {
    background: var(--warning-light);
    border-color: var(--warning);
  }
  .time-override label {
    font-weight: 600;
    color: var(--gray-700);
    white-space: nowrap;
  }
  .time-override input[type="time"] {
    padding: 6px 8px;
    border: 1px solid var(--gray-300);
    border-radius: 6px;
    font-size: 14px;
    width: auto;
    flex: 0 0 auto;
  }
  .time-override .reset-time {
    background: none;
    border: none;
    color: var(--primary);
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    white-space: nowrap;
  }

  /* Responsive */
  @media (min-width: 500px) {
    .quick-add-grid { grid-template-columns: repeat(4, 1fr); }
  }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <h1>Dad's Health Tracker</h1>
  <div class="date-selector">
    <button class="date-nav-btn" onclick="changeDay(-1)" title="Previous day">&#8249;</button>
    <div class="date-display" id="headerDate">
      <span id="dateLabel"></span>
      <input type="date" id="datePicker" onchange="jumpToDate(this.value)">
    </div>
    <button class="date-nav-btn" id="nextDayBtn" onclick="changeDay(1)" title="Next day">&#8250;</button>
  </div>
  <div class="caregiver-toggle">
    <span>Patient</span>
    <div class="toggle-switch" id="modeToggle" onclick="toggleMode()"></div>
    <span>Caregiver</span>
  </div>
</div>
<div class="past-date-banner" id="pastDateBanner" style="display:none;">
  ‚è™ Viewing a past date. Entries will be saved to this date.
  <button onclick="jumpToToday()">Go to Today</button>
</div>

<!-- Toast -->
<div class="toast" id="toast">
  <span class="toast-msg" id="toastMsg"></span>
  <button class="undo-btn" id="undoBtn" style="display:none;" onclick="undoLast()">Undo</button>
  <div class="toast-timer" id="toastTimer"></div>
</div>

<!-- ==================== WATER PAGE ==================== -->
<div class="page active" id="page-water">
  <div id="waterReminder" class="reminder-banner" style="display:none;">
    <span class="icon">üíß</span>
    <span class="text">Time to drink water! Stay hydrated.</span>
    <button class="btn btn-sm btn-warning" onclick="quickAddWater(250)">Log 8oz</button>
  </div>

  <div class="time-override" id="waterTimeBar">
    <label>üïê Time:</label>
    <input type="time" id="waterTimeInput" onchange="onTimeOverrideChange('water')">
    <span style="font-size:12px;color:var(--gray-500);" id="waterTimeLabel">Now</span>
    <button class="reset-time" id="waterTimeReset" style="display:none;" onclick="resetTimeOverride('water')">‚úï Reset to Now</button>
  </div>

  <div class="card">
    <div class="progress-container">
      <div class="progress-ring">
        <svg width="160" height="160">
          <circle cx="80" cy="80" r="70" fill="none" stroke="#e5e7eb" stroke-width="10"/>
          <circle id="waterRing" cx="80" cy="80" r="70" fill="none" stroke="#2563eb" stroke-width="10"
            stroke-dasharray="439.8" stroke-dashoffset="439.8" stroke-linecap="round"/>
        </svg>
        <div class="center-text">
          <span class="amount" id="waterAmount">0</span>
          <span class="label">of <span id="waterGoalDisplay">76</span> oz</span>
        </div>
      </div>
    </div>

    <div class="quick-add-grid">
      <button class="quick-add-btn" onclick="quickAddWater(125)">4 oz</button>
      <button class="quick-add-btn" onclick="quickAddWater(250)">8 oz</button>
      <button class="quick-add-btn" onclick="quickAddWater(355)">12 oz</button>
      <button class="quick-add-btn" onclick="quickAddWater(500)">16 oz</button>
      <button class="quick-add-btn" onclick="quickAddWater(60)">2 oz<br><small>med cup</small></button>
      <button class="quick-add-btn" onclick="openCustomWater()">Custom</button>
    </div>
  </div>

  <div class="card">
    <div class="section-header">
      <h3>Daily Hydration Timeline</h3>
      <span style="font-size:13px; color:var(--gray-500)" id="waterEntryCount">0 entries</span>
    </div>
    <div id="waterTimeline2"></div>
    <div id="waterLog"></div>
  </div>
</div>

<!-- ==================== FOOD PAGE ==================== -->
<div class="page" id="page-food">
  <div class="time-override" id="foodTimeBar">
    <label>üïê Time:</label>
    <input type="time" id="foodTimeInput" onchange="onTimeOverrideChange('food')">
    <span style="font-size:12px;color:var(--gray-500);" id="foodTimeLabel">Now</span>
    <button class="reset-time" id="foodTimeReset" style="display:none;" onclick="resetTimeOverride('food')">‚úï Reset to Now</button>
  </div>
  <div class="card">
    <div class="section-header">
      <span class="section-title">Meals & Nutrition</span>
      <button class="btn btn-sm btn-primary" onclick="openAddMeal()">+ Add Meal</button>
    </div>

    <!-- Calorie Progress -->
    <div style="margin-bottom:14px;">
      <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:4px;">
        <span style="font-size:14px;font-weight:600;color:var(--gray-700);">Calories</span>
        <span style="font-size:14px;"><strong id="calorieCount" style="color:var(--warning)">0</strong> <span style="color:var(--gray-500)">/ <span id="calGoalDisplay">2000</span></span></span>
      </div>
      <div style="height:12px;background:var(--gray-100);border-radius:6px;overflow:hidden;">
        <div id="calBar" style="height:100%;background:var(--warning);border-radius:6px;transition:width 0.3s;width:0%;"></div>
      </div>
    </div>

    <!-- Protein Progress -->
    <div style="margin-bottom:14px;">
      <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:4px;">
        <span style="font-size:14px;font-weight:600;color:var(--gray-700);">Protein</span>
        <span style="font-size:14px;"><strong id="proteinCount" style="color:var(--success)">0</strong><span style="color:var(--gray-500)">g / <span id="proteinGoalDisplay">90</span>g</span></span>
      </div>
      <div style="height:12px;background:var(--gray-100);border-radius:6px;overflow:hidden;">
        <div id="proteinBar" style="height:100%;background:var(--success);border-radius:6px;transition:width 0.3s;width:0%;"></div>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="mealCount" style="color:var(--primary)">0</div>
        <div class="stat-label">Meals</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="snackCount" style="color:var(--purple)">0</div>
        <div class="stat-label">Snacks</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>Quick Log Common Items</h3>
    <div class="quick-add-grid">
      <button class="quick-add-btn" onclick="quickAddFood('Ensure/Boost', 350, 13)">Ensure<br><small>350cal</small></button>
      <button class="quick-add-btn" onclick="quickAddFood('Protein Shake', 200, 30)">Protein<br><small>200cal</small></button>
      <button class="quick-add-btn" onclick="quickAddFood('Broth/Soup', 80, 5)">Broth<br><small>80cal</small></button>
      <button class="quick-add-btn" onclick="quickAddFood('Crackers', 120, 2)">Crackers<br><small>120cal</small></button>
      <button class="quick-add-btn" onclick="quickAddFood('Yogurt', 150, 8)">Yogurt<br><small>150cal</small></button>
      <button class="quick-add-btn" onclick="quickAddFood('Applesauce', 100, 0)">Applesauce<br><small>100cal</small></button>
    </div>
  </div>

  <div class="card">
    <div class="section-header">
      <h3>Daily Meal Timeline</h3>
      <span style="font-size:13px; color:var(--gray-500)" id="foodEntryCount">0 entries</span>
    </div>
    <div id="mealTimeline"></div>
    <div id="foodLog"></div>
  </div>
</div>

<!-- ==================== PT PAGE ==================== -->
<div class="page" id="page-pt">
  <div class="card">
    <div class="section-header">
      <span class="section-title">Physical Therapy</span>
      <button class="btn btn-sm btn-primary" onclick="openAddExercise()">+ Add Exercise</button>
    </div>
    <p style="font-size:13px;color:var(--gray-500);margin-bottom:4px;">
      ‚ö†Ô∏è Go slow. Sit or stand up gradually to avoid dizziness from orthostatic hypotension.
    </p>
    <div style="font-size:13px;color:var(--gray-500);margin-bottom:12px;" id="ptProgress">0/0 done</div>
    <div id="exerciseList"></div>
  </div>

  <div class="card">
    <div class="section-header">
      <h3>Activity Notes</h3>
    </div>
    <textarea id="ptNotes" placeholder="How did PT go today? Any dizziness? Pain levels? Energy level?"
      onchange="savePTNotes()"></textarea>
    <div style="margin-top:8px;">
      <label style="font-size:14px;font-weight:600;color:var(--gray-700);">Energy Level</label>
      <div class="severity-scale" id="energyScale">
        <button class="severity-btn" data-level="1" onclick="setEnergy(1)">1<br><small>Very Low</small></button>
        <button class="severity-btn" data-level="2" onclick="setEnergy(2)">2<br><small>Low</small></button>
        <button class="severity-btn" data-level="3" onclick="setEnergy(3)">3<br><small>OK</small></button>
        <button class="severity-btn" data-level="4" onclick="setEnergy(4)">4<br><small>Good</small></button>
        <button class="severity-btn" data-level="5" onclick="setEnergy(5)">5<br><small>Great</small></button>
      </div>
    </div>
  </div>
</div>

<!-- ==================== MEDS PAGE ==================== -->
<div class="page" id="page-meds">
  <div class="time-override" id="medsTimeBar">
    <label>üïê Time:</label>
    <input type="time" id="medsTimeInput" onchange="onTimeOverrideChange('meds')">
    <span style="font-size:12px;color:var(--gray-500);" id="medsTimeLabel">Now</span>
    <button class="reset-time" id="medsTimeReset" style="display:none;" onclick="resetTimeOverride('meds')">‚úï Reset to Now</button>
  </div>
  <div class="card">
    <div class="section-header">
      <span class="section-title">Medications</span>
      <button class="btn btn-sm btn-primary" onclick="openAddMed()">+ Add Med</button>
    </div>
    <p style="font-size:13px;color:var(--gray-500);margin-bottom:4px;">
      Check off each medication as it's taken. Tap the checkbox to mark taken.
    </p>
    <div style="font-size:13px;color:var(--gray-500);margin-bottom:12px;" id="medProgress">0/0 taken</div>
    <div id="medsList"></div>
    <div id="medsEmpty" class="empty-state" style="display:none;">
      <div class="icon">üíä</div>
      <p>No medications added yet.<br>Tap "+ Add Med" to get started.</p>
    </div>
  </div>

  <div class="card" id="discontinuedCard" style="display:none;">
    <div class="section-header">
      <h3>Discontinued Medications</h3>
    </div>
    <p style="font-size:12px;color:var(--gray-500);margin-bottom:8px;">These meds were removed but history is preserved from previous days.</p>
    <div id="discontinuedList"></div>
  </div>

  <div class="card">
    <h3>Medication Log Today</h3>
    <div id="medLog"></div>
  </div>
</div>

<!-- ==================== SYMPTOMS PAGE ==================== -->
<div class="page" id="page-symptoms">
  <div class="time-override" id="symptomsTimeBar">
    <label>üïê Time:</label>
    <input type="time" id="symptomsTimeInput" onchange="onTimeOverrideChange('symptoms')">
    <span style="font-size:12px;color:var(--gray-500);" id="symptomsTimeLabel">Now</span>
    <button class="reset-time" id="symptomsTimeReset" style="display:none;" onclick="resetTimeOverride('symptoms')">‚úï Reset to Now</button>
  </div>

  <div class="card">
    <div class="section-header">
      <span class="section-title">Symptom Tracker</span>
    </div>

    <label style="font-size:14px;font-weight:600;color:var(--gray-700);margin-bottom:6px;display:block;">
      What are you experiencing?
    </label>
    <div class="symptom-chips" id="symptomChips">
      <button class="symptom-chip" onclick="toggleSymptom(this)" data-symptom="Dizziness">Dizziness</button>
      <button class="symptom-chip" onclick="toggleSymptom(this)" data-symptom="Nausea">Nausea</button>
      <button class="symptom-chip" onclick="toggleSymptom(this)" data-symptom="Fatigue">Fatigue</button>
      <button class="symptom-chip" onclick="toggleSymptom(this)" data-symptom="Skin tightness">Skin tightness</button>
      <button class="symptom-chip" onclick="toggleSymptom(this)" data-symptom="Skin rash">Skin rash</button>
      <button class="symptom-chip" onclick="toggleSymptom(this)" data-symptom="Dry mouth">Dry mouth</button>
      <button class="symptom-chip" onclick="toggleSymptom(this)" data-symptom="Dry eyes">Dry eyes</button>
      <button class="symptom-chip" onclick="toggleSymptom(this)" data-symptom="Joint pain">Joint pain</button>
      <button class="symptom-chip" onclick="toggleSymptom(this)" data-symptom="Muscle weakness">Muscle weakness</button>
      <button class="symptom-chip" onclick="toggleSymptom(this)" data-symptom="Shortness of breath">Shortness of breath</button>
      <button class="symptom-chip" onclick="toggleSymptom(this)" data-symptom="Mouth sores">Mouth sores</button>
      <button class="symptom-chip" onclick="toggleSymptom(this)" data-symptom="Difficulty swallowing">Difficulty swallowing</button>
      <button class="symptom-chip" onclick="toggleSymptom(this)" data-symptom="Lightheaded on standing">Lightheaded on standing</button>
      <button class="symptom-chip" onclick="toggleSymptom(this)" data-symptom="Fall/Near fall">Fall/Near fall</button>
    </div>

    <div class="form-group">
      <label>Severity</label>
      <div class="severity-scale" id="symptomSeverity">
        <button class="severity-btn" data-level="1" onclick="setSymptomSeverity(1)">1<br><small>Mild</small></button>
        <button class="severity-btn" data-level="2" onclick="setSymptomSeverity(2)">2</button>
        <button class="severity-btn" data-level="3" onclick="setSymptomSeverity(3)">3<br><small>Moderate</small></button>
        <button class="severity-btn" data-level="4" onclick="setSymptomSeverity(4)">4</button>
        <button class="severity-btn" data-level="5" onclick="setSymptomSeverity(5)">5<br><small>Severe</small></button>
      </div>
    </div>

    <div class="form-group">
      <label>Notes (position, activity at time, etc.)</label>
      <textarea id="symptomNotes" placeholder="e.g., Got dizzy when standing up from bed..."></textarea>
    </div>

    <button class="btn btn-danger btn-block" onclick="logSymptom()">Log Symptoms</button>
  </div>

  <div class="card">
    <h3>Today's Symptom Log</h3>
    <div id="symptomLog"></div>
  </div>
</div>

<!-- ==================== SUMMARY PAGE ==================== -->
<div class="page" id="page-summary">
  <div class="card" style="background:linear-gradient(135deg,#f0f4ff,#e8f0fe);border:1px solid var(--primary-light);">
    <div class="section-header">
      <span class="section-title">Patient Info</span>
      <button class="btn btn-sm btn-primary" onclick="generateReport()">üìã Copy Report</button>
    </div>
    <div style="font-size:15px;font-weight:700;margin-bottom:4px;">William Frank Barkwell</div>
    <div style="font-size:13px;color:var(--gray-700);line-height:1.6;">
      DOB: April 5, 1953 (Age <span id="patientAge"></span>) ¬∑ Height: 5'11" ¬∑ Weight:
      <span id="currentWeight" onclick="openUpdateWeight()" style="cursor:pointer;border-bottom:1px dashed var(--primary);color:var(--primary);font-weight:600;">152 lbs</span>
      <span style="font-size:11px;color:var(--gray-500);">(tap to update)</span>
    </div>
    <div id="weightTrend" style="margin-top:6px;font-size:12px;color:var(--gray-500);"></div>
  </div>

  <div class="card">
    <div class="section-header">
      <span class="section-title">Today's Progress</span>
    </div>
    <div class="date" id="summaryDate" style="color:var(--gray-500);font-size:13px;margin-bottom:12px;"></div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="sumWater" style="color:var(--primary)">0</div>
        <div class="stat-label">oz Water</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="sumCalories" style="color:var(--warning)">0</div>
        <div class="stat-label">of <span id="sumCalGoal">2000</span> cal</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="sumProtein" style="color:var(--success)">0</div>
        <div class="stat-label">of <span id="sumProtGoal">90</span>g protein</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="sumExercises" style="color:var(--purple)">0/0</div>
        <div class="stat-label">PT Exercises</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>Hydration Today</h3>
    <div id="sumWaterLog"></div>
  </div>

  <div class="card">
    <h3>Meals Today</h3>
    <div id="sumMeals"></div>
  </div>

  <div class="card">
    <h3>Symptoms Reported</h3>
    <div id="sumSymptoms"></div>
  </div>

  <div class="card">
    <h3>Medications</h3>
    <div id="sumMeds"></div>
  </div>

  <div id="reportOutput" style="display:none;">
    <div class="card" style="background:var(--gray-50);border:2px dashed var(--gray-300);">
      <h3>Report Text (Copied!)</h3>
      <pre id="reportText" style="white-space:pre-wrap;font-size:12px;max-height:300px;overflow-y:auto;"></pre>
    </div>
  </div>

  <div class="card">
    <div class="section-header">
      <h3>Data Management</h3>
    </div>
    <p style="font-size:13px;color:var(--gray-500);margin-bottom:12px;">
      Export all data to transfer to another device or keep a backup. Import to restore from a previous export.
    </p>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button class="btn btn-primary" onclick="exportAllData()" style="flex:1;min-width:140px;">
        ‚¨áÔ∏è Export All Data
      </button>
      <button class="btn btn-outline" onclick="document.getElementById('importFile').click()" style="flex:1;min-width:140px;">
        ‚¨ÜÔ∏è Import Data
      </button>
      <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importData(event)">
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
      <button class="btn btn-sm btn-outline" onclick="exportTodayData()" style="font-size:12px;">
        Export Today Only
      </button>
      <button class="btn btn-sm btn-outline" onclick="exportAsCSV()" style="font-size:12px;">
        Export as CSV
      </button>
    </div>
    <div id="importStatus" style="display:none;margin-top:10px;padding:10px;border-radius:8px;font-size:13px;"></div>
  </div>
</div>

<!-- ==================== MODALS ==================== -->
<!-- Add Meal Modal -->
<div class="modal-overlay" id="mealModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('mealModal')">&times;</button>
    <h2>Log a Meal</h2>
    <div class="form-group">
      <label>Time (leave blank for now, or backdate)</label>
      <input type="time" id="mealTime">
    </div>
    <div class="form-group">
      <label>Meal Type</label>
      <select id="mealType">
        <option value="Breakfast">Breakfast</option>
        <option value="Lunch">Lunch</option>
        <option value="Dinner">Dinner</option>
        <option value="Snack">Snack</option>
        <option value="Supplement">Supplement/Drink</option>
      </select>
    </div>
    <div class="form-group">
      <label>What did you eat/drink?</label>
      <input type="text" id="mealDesc" placeholder="e.g., Half a chicken breast with rice">
    </div>
    <div class="form-group">
      <label>Estimated Calories</label>
      <input type="number" id="mealCal" placeholder="e.g., 300">
    </div>
    <div class="form-group">
      <label>Protein (grams, optional)</label>
      <input type="number" id="mealProtein" placeholder="e.g., 20">
    </div>
    <div class="form-group">
      <label>Portion Eaten</label>
      <select id="mealPortion">
        <option value="All">All of it</option>
        <option value="Most">Most (75%)</option>
        <option value="Half">About half</option>
        <option value="Some">Some (25%)</option>
        <option value="A few bites">A few bites</option>
      </select>
    </div>
    <div class="form-group">
      <label>Notes (optional)</label>
      <textarea id="mealNotes" rows="2" placeholder="Any issues? Nausea? Difficulty swallowing?"></textarea>
    </div>
    <button class="btn btn-success btn-block btn-lg" onclick="saveMeal()">Save Meal</button>
  </div>
</div>

<!-- Add Med Modal -->
<div class="modal-overlay" id="medModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('medModal')">&times;</button>
    <h2>Add Medication</h2>
    <div class="form-group">
      <label>Medication Name</label>
      <input type="text" id="medName" placeholder="e.g., Tacrolimus">
    </div>
    <div class="form-group">
      <label>Dosage</label>
      <input type="text" id="medDose" placeholder="e.g., 1mg twice daily">
    </div>
    <div class="form-group">
      <label>Schedule</label>
      <select id="medSchedule">
        <option value="Morning">Morning</option>
        <option value="Afternoon">Afternoon</option>
        <option value="Evening">Evening</option>
        <option value="Bedtime">Bedtime</option>
        <option value="With meals">With meals</option>
        <option value="As needed">As needed</option>
      </select>
    </div>
    <div class="form-group">
      <label>Notes (optional)</label>
      <input type="text" id="medNotes" placeholder="e.g., Take with food">
    </div>
    <button class="btn btn-primary btn-block btn-lg" onclick="saveMed()">Add Medication</button>
  </div>
</div>

<!-- Custom Water Modal -->
<div class="modal-overlay" id="waterModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('waterModal')">&times;</button>
    <h2>Custom Water Amount</h2>
    <div class="form-group">
      <label>Time (leave blank for now, or backdate)</label>
      <input type="time" id="customWaterTime">
    </div>
    <div class="form-group">
      <label>Amount (oz)</label>
      <input type="number" id="customWaterOz" placeholder="e.g., 10">
    </div>
    <div class="form-group">
      <label>Type (optional)</label>
      <select id="customWaterType">
        <option value="Water">Water</option>
        <option value="Ice chips">Ice chips</option>
        <option value="Electrolyte drink">Electrolyte drink</option>
        <option value="Juice">Juice</option>
        <option value="Tea">Tea</option>
        <option value="IV Fluids">IV Fluids</option>
        <option value="Other">Other</option>
      </select>
    </div>
    <button class="btn btn-primary btn-block btn-lg" onclick="saveCustomWater()">Add</button>
  </div>
</div>

<!-- Update Weight Modal -->
<div class="modal-overlay" id="weightModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('weightModal')">&times;</button>
    <h2>Update Weight</h2>
    <div class="form-group">
      <label>Current Weight (lbs)</label>
      <input type="number" id="newWeight" placeholder="e.g., 155" step="0.1">
    </div>
    <div class="form-group">
      <label>Notes (optional)</label>
      <input type="text" id="weightNotes" placeholder="e.g., Before breakfast, with clothes">
    </div>
    <button class="btn btn-primary btn-block btn-lg" onclick="saveWeight()">Update Weight</button>
    <div id="weightHistory" style="margin-top:16px;"></div>
  </div>
</div>

<!-- Add Exercise Modal -->
<div class="modal-overlay" id="exerciseModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('exerciseModal')">&times;</button>
    <h2>Add Exercise / Activity</h2>
    <div class="form-group">
      <label>Type</label>
      <select id="exType" onchange="updateExFields()">
        <option value="Walk">Walk</option>
        <option value="Prescribed Exercise">Doctor-Prescribed Exercise</option>
        <option value="Stretch">Stretch</option>
        <option value="Strength">Strength / Resistance</option>
        <option value="Balance">Balance Exercise</option>
        <option value="Breathing">Breathing Exercise</option>
        <option value="Other">Other Activity</option>
      </select>
    </div>
    <div class="form-group">
      <label>Name</label>
      <input type="text" id="exName" placeholder="e.g., Hallway walk, Arm raises">
    </div>
    <div class="form-group">
      <label>Description / Instructions</label>
      <textarea id="exDesc" rows="2" placeholder="e.g., Walk to end of hallway and back, 2x with walker"></textarea>
    </div>
    <div class="form-group" id="exDurationGroup">
      <label>Duration or Reps (optional)</label>
      <input type="text" id="exDuration" placeholder="e.g., 10 minutes, 3 sets of 10">
    </div>
    <div style="display:flex;gap:8px;">
      <label style="display:flex;align-items:center;gap:6px;font-size:14px;cursor:pointer;">
        <input type="checkbox" id="exSaveGlobal" checked style="width:18px;height:18px;">
        Add to daily routine (appears every day)
      </label>
    </div>
    <div style="margin-top:12px;">
      <button class="btn btn-success btn-block btn-lg" onclick="saveExercise()">Add Exercise</button>
    </div>
  </div>
</div>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
  <button class="nav-item active" onclick="switchPage('water')" id="nav-water">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L5 12c0 3.87 3.13 7 7 7s7-3.13 7-7L12 2z"/></svg>
    Water
  </button>
  <button class="nav-item" onclick="switchPage('food')" id="nav-food">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8h1a4 4 0 010 8h-1M2 8h16v9a4 4 0 01-4 4H6a4 4 0 01-4-4V8zM6 1v3M10 1v3M14 1v3"/></svg>
    Food
  </button>
  <button class="nav-item" onclick="switchPage('pt')" id="nav-pt">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 4v16M7 4v16M3 8h4M13 8h8M3 16h4M13 16h8"/></svg>
    PT
  </button>
  <button class="nav-item" onclick="switchPage('meds')" id="nav-meds">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.5 1.5H8.25A2.25 2.25 0 006 3.75v16.5a2.25 2.25 0 002.25 2.25h7.5A2.25 2.25 0 0018 20.25V3.75a2.25 2.25 0 00-2.25-2.25H13.5m-3 0V3h3V1.5m-3 0h3m-6 9h6m-6 4h6"/></svg>
    Meds
  </button>
  <button class="nav-item" onclick="switchPage('symptoms')" id="nav-symptoms">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
    Symptoms
  </button>
  <button class="nav-item" onclick="switchPage('summary')" id="nav-summary">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 17v-6M13 17v-4M17 17v-8M3 3v16a2 2 0 002 2h16"/></svg>
    Summary
  </button>
</nav>

<script>
// ==================== DATA LAYER ====================
const REAL_TODAY = new Date().toISOString().split('T')[0];
let selectedDate = REAL_TODAY;

function getStore(key, fallback) {
  try {
    const data = localStorage.getItem(key + '_' + selectedDate);
    return data ? JSON.parse(data) : fallback;
  } catch { return fallback; }
}
function setStore(key, val) {
  try { localStorage.setItem(key + '_' + selectedDate, JSON.stringify(val)); } catch {}
}
function getGlobal(key, fallback) {
  try {
    const data = localStorage.getItem(key);
    return data ? JSON.parse(data) : fallback;
  } catch { return fallback; }
}
function setGlobal(key, val) {
  try { localStorage.setItem(key, JSON.stringify(val)); } catch {}
}

// ==================== STATE ====================
let waterLog = getStore('waterLog', []);
let foodLog = getStore('foodLog', []);
let exercises = getStore('exercises', null);
let ptNotes = getStore('ptNotes', { notes: '', energy: 0 });
let medsTaken = getStore('medsTaken', []);
let symptomLog = getStore('symptomLog', []);
let caregiverMode = getGlobal('caregiverMode', false);
let waterGoalOz = getGlobal('waterGoalOz', 76); // 152 lbs √∑ 2 = 76 oz recommended daily
let calorieGoal = getGlobal('calorieGoal', 2000); // Recovery target for 152 lb BMT patient
let proteinGoal = getGlobal('proteinGoal', 90); // ~1.3g/kg for recovery (152 lbs = 69 kg)
let weightHistory = getGlobal('weightHistory', [{ lbs: 152, date: '2026-02-23', time: new Date().toISOString(), notes: 'Starting weight' }]);
let selectedSymptoms = [];
let currentSymptomSeverity = 0;

// Default exercises for BMT/GVHD/Scleroderma recovery
const DEFAULT_EXERCISES = [
  { id: 1, name: "Ankle Pumps", desc: "10 reps each foot ‚Äî do while sitting or lying", type: "Prescribed Exercise", done: false },
  { id: 2, name: "Seated Marching", desc: "Lift knees while seated, 10 reps each side", type: "Prescribed Exercise", done: false },
  { id: 3, name: "Sit to Stand", desc: "Stand up from chair slowly, 5 reps ‚Äî hold onto support", type: "Strength", done: false },
  { id: 4, name: "Standing Balance", desc: "Hold onto support, stand 30 seconds, rest, repeat 3x", type: "Balance", done: false },
  { id: 5, name: "Gentle Walking", desc: "Walk hallway or room with support if needed ‚Äî note distance", type: "Walk", done: false },
  { id: 6, name: "Hand Squeezes", desc: "Squeeze soft ball or towel, 10 reps each hand (scleroderma)", type: "Strength", done: false },
  { id: 7, name: "Finger Stretches", desc: "Spread fingers wide, hold 5 sec, repeat 10x (scleroderma)", type: "Stretch", done: false },
  { id: 8, name: "Shoulder Rolls", desc: "Roll shoulders forward and back, 10 each direction", type: "Stretch", done: false },
  { id: 9, name: "Deep Breathing", desc: "Breathe in 4 counts, hold 4, out 4 ‚Äî repeat 5x", type: "Breathing", done: false },
  { id: 10, name: "Gentle Neck Stretches", desc: "Tilt head side to side, hold 10 sec each ‚Äî 3 reps", type: "Stretch", done: false }
];

// Global exercise library (persists across days, user can add custom ones)
let exerciseLibrary = getGlobal('exerciseLibrary', null);
if (!exerciseLibrary) {
  exerciseLibrary = DEFAULT_EXERCISES.map(e => ({...e, done: undefined}));
  setGlobal('exerciseLibrary', exerciseLibrary);
}

if (!exercises) {
  // Build today's exercise list from the library
  exercises = exerciseLibrary.map(e => ({...e, done: false, completedAt: null}));
  setStore('exercises', exercises);
}

// Default medications from BMT clinic med list
const DEFAULT_MEDICATIONS = [
  { id: 1, name: "Metoprolol Tartrate", dose: "25mg tablet", schedule: "Twice daily", notes: "Hold for SBP<100 or HR<60", active: true },
  { id: 2, name: "Cequa 0.09% Eye Drops", dose: "1 drop each eye", schedule: "Every 12 hours", notes: "For ocular GVHD", active: true },
  { id: 3, name: "Synthroid", dose: "50mcg tablet", schedule: "Morning", notes: "", active: true },
  { id: 4, name: "Colace", dose: "100mg capsule", schedule: "Twice daily", notes: "As needed for constipation", active: true },
  { id: 5, name: "Xarelto", dose: "20mg tablet", schedule: "Morning", notes: "", active: true },
  { id: 6, name: "Multivitamin", dose: "1 tablet", schedule: "Morning", notes: "", active: true },
  { id: 7, name: "Cresemba", dose: "186mg, 2 capsules", schedule: "Once daily", notes: "", active: true },
  { id: 8, name: "Atovaquone", dose: "750mg/5mL, take 10mL", schedule: "Once daily", notes: "Take with a fatty meal. PCP preventative.", active: true },
  { id: 9, name: "Acyclovir", dose: "800mg tablet", schedule: "Twice daily", notes: "Preventative antiviral", active: true },
  { id: 10, name: "Vitamin D2", dose: "50,000 units capsule", schedule: "Weekly", notes: "", active: true },
  { id: 11, name: "Eysuvis 0.25% Eye Drops", dose: "Per ophthalmology", schedule: "As directed", notes: "", active: true },
  { id: 12, name: "Rezurock", dose: "200mg tablet", schedule: "Once daily", notes: "Take with food", active: true },
  { id: 13, name: "Tramadol", dose: "50mg tablet", schedule: "Every 6 hours", notes: "As needed for pain", active: true },
  { id: 14, name: "Penicillin V Potassium", dose: "500mg, take 2 tabs (1000mg)", schedule: "Once daily", notes: "Prevent infection. HOLD WHILE RECEIVING ANCEF", active: true },
  { id: 15, name: "Cefazolin (Ancef)", dose: "2g IV solution", schedule: "Every 8 hours", notes: "Via home health", active: true }
];

let medications = getGlobal('medications', null);
if (!medications) {
  medications = DEFAULT_MEDICATIONS.map(m => ({...m}));
  setGlobal('medications', medications);
}

// ==================== INIT ====================
function init() {
  updateDateDisplay();
  if (caregiverMode) document.getElementById('modeToggle').classList.add('on');

  renderWater();
  renderFood();
  renderExercises();
  renderMeds();
  renderSymptoms();
  updateSummary();
  updateWeightDisplay();
  startHydrationReminder();
}

function updateDateDisplay() {
  const d = new Date(selectedDate + 'T12:00:00'); // noon to avoid timezone issues
  const isToday = selectedDate === REAL_TODAY;
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  const isYesterday = selectedDate === yesterday.toISOString().split('T')[0];

  let label = d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
  if (isToday) label = 'Today ‚Äî ' + label;
  else if (isYesterday) label = 'Yesterday ‚Äî ' + label;

  document.getElementById('dateLabel').textContent = label;
  document.getElementById('datePicker').value = selectedDate;
  document.getElementById('summaryDate').textContent = label;

  // Show/hide past date banner
  document.getElementById('pastDateBanner').style.display = isToday ? 'none' : 'block';

  // Disable next button if on today
  document.getElementById('nextDayBtn').disabled = isToday;
}

function changeDay(offset) {
  const d = new Date(selectedDate + 'T12:00:00');
  d.setDate(d.getDate() + offset);
  const newDate = d.toISOString().split('T')[0];
  // Don't go past today
  if (newDate > REAL_TODAY) return;
  selectedDate = newDate;
  reloadData();
}

function jumpToDate(dateStr) {
  if (!dateStr) return;
  if (dateStr > REAL_TODAY) {
    showToast("Can't log for future dates");
    return;
  }
  selectedDate = dateStr;
  reloadData();
}

function jumpToToday() {
  selectedDate = REAL_TODAY;
  reloadData();
}

function reloadData() {
  // Reload all date-specific data from storage
  waterLog = getStore('waterLog', []);
  foodLog = getStore('foodLog', []);
  exercises = getStore('exercises', null);
  ptNotes = getStore('ptNotes', { notes: '', energy: 0 });
  medsTaken = getStore('medsTaken', []);
  symptomLog = getStore('symptomLog', []);

  if (!exercises) {
    // Build from the global exercise library for this new day
    exercises = exerciseLibrary.map(e => ({...e, done: false, completedAt: null}));
    setStore('exercises', exercises);
  }

  updateDateDisplay();
  renderWater();
  renderFood();
  renderExercises();
  renderMeds();
  renderSymptoms();
  updateSummary();
}

// ==================== NAVIGATION ====================
function switchPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  document.getElementById('nav-' + page).classList.add('active');
  if (page === 'summary') updateSummary();
}

function toggleMode() {
  caregiverMode = !caregiverMode;
  document.getElementById('modeToggle').classList.toggle('on');
  setGlobal('caregiverMode', caregiverMode);
  showToast(caregiverMode ? 'Caregiver mode ON' : 'Patient mode ON');
}

// ==================== TOAST & UNDO ====================
let undoStack = []; // stores undo actions
let toastTimeout = null;
const UNDO_DURATION = 5000; // 5 seconds to undo

function showToast(msg, undoable) {
  const t = document.getElementById('toast');
  const msgEl = document.getElementById('toastMsg');
  const undoBtn = document.getElementById('undoBtn');
  const timer = document.getElementById('toastTimer');

  // Clear previous timeout
  if (toastTimeout) clearTimeout(toastTimeout);

  msgEl.textContent = msg;

  if (undoable) {
    undoBtn.style.display = 'inline-block';
    // Animate timer bar
    timer.style.transition = 'none';
    timer.style.width = '100%';
    requestAnimationFrame(() => {
      timer.style.transition = `width ${UNDO_DURATION}ms linear`;
      timer.style.width = '0%';
    });
  } else {
    undoBtn.style.display = 'none';
    timer.style.width = '0%';
  }

  t.classList.add('show');
  toastTimeout = setTimeout(() => {
    t.classList.remove('show');
    // Clear the undo stack entry after timeout (can no longer undo)
    if (undoable && undoStack.length > 0) {
      undoStack.pop();
    }
  }, undoable ? UNDO_DURATION : 2000);
}

function pushUndo(type, data) {
  undoStack.push({ type, data, timestamp: Date.now() });
}

function undoLast() {
  if (undoStack.length === 0) return;
  const action = undoStack.pop();
  const t = document.getElementById('toast');
  if (toastTimeout) clearTimeout(toastTimeout);
  t.classList.remove('show');

  switch (action.type) {
    case 'addWater': {
      const idx = waterLog.findIndex(e => e.time === action.data.time && e.oz === action.data.oz);
      if (idx !== -1) { waterLog.splice(idx, 1); setStore('waterLog', waterLog); }
      renderWater();
      showToast('Water entry undone');
      break;
    }
    case 'addFood': {
      const idx = foodLog.findIndex(e => e.time === action.data.time && e.desc === action.data.desc);
      if (idx !== -1) { foodLog.splice(idx, 1); setStore('foodLog', foodLog); }
      renderFood();
      showToast('Meal entry undone');
      break;
    }
    case 'toggleExercise': {
      const ex = exercises[action.data.idx];
      if (ex) {
        ex.done = action.data.prevDone;
        ex.completedAt = action.data.prevCompletedAt;
        setStore('exercises', exercises);
      }
      renderExercises();
      showToast('Exercise undone');
      break;
    }
    case 'takeMed': {
      // Restore previous state
      medsTaken = action.data.prevMedsTaken;
      setStore('medsTaken', medsTaken);
      renderMeds();
      showToast('Medication undone');
      break;
    }
    case 'addSymptom': {
      const idx = symptomLog.findIndex(e => e.time === action.data.time);
      if (idx !== -1) { symptomLog.splice(idx, 1); setStore('symptomLog', symptomLog); }
      renderSymptoms();
      showToast('Symptom entry undone');
      break;
    }
    case 'addExercise': {
      const idx = exercises.findIndex(e => e.id === action.data.id);
      if (idx !== -1) { exercises.splice(idx, 1); setStore('exercises', exercises); }
      // Also remove from library if it was added there
      if (action.data.addedToLibrary) {
        const libIdx = exerciseLibrary.findIndex(e => e.id === action.data.id);
        if (libIdx !== -1) { exerciseLibrary.splice(libIdx, 1); setGlobal('exerciseLibrary', exerciseLibrary); }
      }
      renderExercises();
      showToast('Exercise removed');
      break;
    }
    case 'addMed': {
      medications = medications.filter(m => m.id !== action.data.id);
      setGlobal('medications', medications);
      renderMeds();
      showToast('Medication removed');
      break;
    }
    case 'discontinueMed': {
      const med = medications.find(m => m.id === action.data.medId);
      if (med) { med.active = true; delete med.discontinuedDate; setGlobal('medications', medications); renderMeds(); }
      showToast(`${action.data.name} restored`);
      break;
    }
    case 'addWeight': {
      const idx = weightHistory.findIndex(e => e.time === action.data.time);
      if (idx !== -1) { weightHistory.splice(idx, 1); setGlobal('weightHistory', weightHistory); }
      updateWeightDisplay();
      showToast('Weight entry undone');
      break;
    }
    default:
      showToast('Undo not available');
  }
}

// ==================== TIME OVERRIDE ====================
// Each page has a time override; when set, entries use that time instead of now
let timeOverrides = { water: null, food: null, meds: null, symptoms: null };

function getTimestamp(page) {
  const override = timeOverrides[page];
  if (override) {
    // Build an ISO string for the selected date + override time
    return new Date(selectedDate + 'T' + override + ':00').toISOString();
  }
  return new Date().toISOString();
}

function getTimestampFromInput(inputId) {
  // For modal time inputs ‚Äî if a value is set, use it; otherwise use now
  const val = document.getElementById(inputId).value;
  if (val) {
    return new Date(selectedDate + 'T' + val + ':00').toISOString();
  }
  return new Date().toISOString();
}

function onTimeOverrideChange(page) {
  const input = document.getElementById(page + 'TimeInput');
  const label = document.getElementById(page + 'TimeLabel');
  const reset = document.getElementById(page + 'TimeReset');
  const bar = document.getElementById(page + 'TimeBar');
  if (input.value) {
    timeOverrides[page] = input.value;
    label.textContent = 'Logging at ' + formatTimeStr(input.value);
    label.style.color = 'var(--warning)';
    label.style.fontWeight = '600';
    reset.style.display = 'inline';
    bar.classList.add('active');
  } else {
    resetTimeOverride(page);
  }
}

function resetTimeOverride(page) {
  timeOverrides[page] = null;
  const input = document.getElementById(page + 'TimeInput');
  const label = document.getElementById(page + 'TimeLabel');
  const reset = document.getElementById(page + 'TimeReset');
  const bar = document.getElementById(page + 'TimeBar');
  input.value = '';
  label.textContent = 'Now';
  label.style.color = 'var(--gray-500)';
  label.style.fontWeight = 'normal';
  reset.style.display = 'none';
  bar.classList.remove('active');
}

function formatTimeStr(timeStr) {
  const [h, m] = timeStr.split(':');
  const hr = parseInt(h);
  const ampm = hr >= 12 ? 'PM' : 'AM';
  const hr12 = hr % 12 || 12;
  return hr12 + ':' + m + ' ' + ampm;
}

// ==================== MODAL ====================
function closeModal(id) {
  document.getElementById(id).classList.remove('active');
}

// ==================== WATER ====================
function mlToOz(ml) { return Math.round(ml / 29.5735); }

function quickAddWater(ml) {
  const oz = mlToOz(ml);
  const entry = { oz, ml, type: 'Water', time: getTimestamp('water') };
  waterLog.push(entry);
  setStore('waterLog', waterLog);
  renderWater();
  pushUndo('addWater', entry);
  showToast(`+${oz} oz water logged!`, true);
}

function openCustomWater() {
  document.getElementById('waterModal').classList.add('active');
  document.getElementById('customWaterOz').value = '';
  document.getElementById('customWaterTime').value = '';
}

function saveCustomWater() {
  const oz = parseInt(document.getElementById('customWaterOz').value);
  const type = document.getElementById('customWaterType').value;
  if (!oz || oz <= 0) return showToast('Please enter a valid amount');
  const entry = { oz, ml: Math.round(oz * 29.5735), type, time: getTimestampFromInput('customWaterTime') };
  waterLog.push(entry);
  setStore('waterLog', waterLog);
  renderWater();
  closeModal('waterModal');
  pushUndo('addWater', entry);
  showToast(`+${oz} oz ${type} logged!`, true);
}

function getWaterDotClass(type) {
  const t = (type || 'Water').toLowerCase();
  if (t.includes('ice')) return 'ice';
  if (t.includes('electrolyte')) return 'electrolyte';
  if (t.includes('iv')) return 'iv';
  if (t.includes('juice')) return 'juice';
  if (t.includes('tea')) return 'tea';
  if (t === 'water') return 'water';
  return 'otherdrink';
}

function renderWater() {
  const totalOz = waterLog.reduce((s, e) => s + e.oz, 0);
  document.getElementById('waterAmount').textContent = totalOz;
  document.getElementById('waterGoalDisplay').textContent = waterGoalOz;
  const pct = Math.min(totalOz / waterGoalOz, 1);
  const ring = document.getElementById('waterRing');
  ring.style.strokeDashoffset = 439.8 * (1 - pct);
  ring.style.stroke = pct >= 1 ? '#16a34a' : '#2563eb';
  document.getElementById('waterEntryCount').textContent = waterLog.length + ' entries';

  const tlEl = document.getElementById('waterTimeline2');
  const logEl = document.getElementById('waterLog');
  if (waterLog.length === 0) {
    tlEl.innerHTML = '';
    logEl.innerHTML = '<div class="empty-state"><div class="icon">üíß</div><p>No water logged yet today.<br>Goal: ' + waterGoalOz + ' oz</p></div>';
    return;
  }

  // Build timeline sorted chronologically
  const sorted = waterLog.map((e, i) => ({...e, origIdx: i})).sort((a, b) => new Date(a.time) - new Date(b.time));
  let runningOz = 0;
  let timelineHTML = '<div class="meal-timeline">';
  sorted.forEach((e, i) => {
    const t = new Date(e.time);
    const dotClass = getWaterDotClass(e.type);
    runningOz += e.oz;

    // Gap warning if > 1.5 hours between drinks
    if (i > 0) {
      const prevTime = new Date(sorted[i-1].time);
      const gapMins = (t - prevTime) / (1000 * 60);
      if (gapMins >= 90) {
        const gapH = Math.floor(gapMins / 60);
        const gapM = Math.round(gapMins % 60);
        timelineHTML += `<div class="tl-gap-warning"><span class="gap-label">‚ö†Ô∏è ${gapH > 0 ? gapH + 'h ' : ''}${gapM}m gap</span></div>`;
      }
    }

    timelineHTML += `
      <div class="tl-item">
        <div class="tl-dot ${dotClass}"></div>
        <div>
          <span class="tl-time">${t.toLocaleTimeString([], {hour:'numeric',minute:'2-digit'})}</span>
          <span class="tl-type ${dotClass}">${e.type}</span>
          <div class="tl-desc">${e.oz} oz</div>
          <div class="tl-meta">Running total: ${runningOz} oz (${Math.round(runningOz / waterGoalOz * 100)}% of goal)</div>
        </div>
      </div>`;
  });
  timelineHTML += '</div>';
  tlEl.innerHTML = timelineHTML;

  // Edit log with delete buttons
  logEl.innerHTML = '<h3 style="font-size:14px;color:var(--gray-500);margin:12px 0 8px;border-top:1px solid var(--gray-200);padding-top:12px;">Edit Log</h3>' +
    waterLog.slice().reverse().map((e, i) => {
    const realIdx = waterLog.length - 1 - i;
    const t = new Date(e.time);
    return `<div class="log-entry">
      <div class="info">
        <div class="time">${t.toLocaleTimeString([], {hour:'numeric',minute:'2-digit'})}</div>
        <div class="detail">${e.oz} oz</div>
        <div class="sub">${e.type}</div>
      </div>
      <button class="delete-btn" onclick="deleteWater(${realIdx})">‚úï</button>
    </div>`;
  }).join('');
}

function deleteWater(idx) {
  waterLog.splice(idx, 1);
  setStore('waterLog', waterLog);
  renderWater();
}

// ==================== HYDRATION REMINDER ====================
let reminderInterval;
function startHydrationReminder() {
  checkHydrationReminder();
  reminderInterval = setInterval(checkHydrationReminder, 60 * 1000); // check every minute
}

function checkHydrationReminder() {
  const now = new Date();
  const hour = now.getHours();
  // Only remind during waking hours (7am - 10pm)
  if (hour < 7 || hour > 22) {
    document.getElementById('waterReminder').style.display = 'none';
    return;
  }
  // Check if water was logged in the last 45 minutes
  const recent = waterLog.filter(e => (now - new Date(e.time)) < 45 * 60 * 1000);
  if (recent.length === 0) {
    document.getElementById('waterReminder').style.display = 'flex';
    // Try browser notification
    if (Notification && Notification.permission === 'granted') {
      // Only notify every 30 min
      const lastNotify = getGlobal('lastHydrationNotify', 0);
      if (now.getTime() - lastNotify > 30 * 60 * 1000) {
        new Notification("üíß Time to drink water!", { body: "Stay hydrated ‚Äî it helps with your blood pressure." });
        setGlobal('lastHydrationNotify', now.getTime());
      }
    }
  } else {
    document.getElementById('waterReminder').style.display = 'none';
  }
}

// Request notification permission
if (typeof Notification !== 'undefined' && Notification.permission === 'default') {
  setTimeout(() => Notification.requestPermission(), 3000);
}

// ==================== FOOD ====================
function openAddMeal() {
  document.getElementById('mealModal').classList.add('active');
  document.getElementById('mealDesc').value = '';
  document.getElementById('mealCal').value = '';
  document.getElementById('mealProtein').value = '';
  document.getElementById('mealNotes').value = '';
  document.getElementById('mealTime').value = '';
}

function quickAddFood(name, cal, protein) {
  const entry = {
    type: 'Snack', desc: name, calories: cal, protein: protein,
    portion: 'All', notes: '', time: getTimestamp('food')
  };
  foodLog.push(entry);
  setStore('foodLog', foodLog);
  renderFood();
  pushUndo('addFood', entry);
  showToast(`${name} logged! (${cal} cal)`, true);
}

function saveMeal() {
  const desc = document.getElementById('mealDesc').value.trim();
  if (!desc) return showToast('Please describe the meal');
  const cal = parseInt(document.getElementById('mealCal').value) || 0;
  const protein = parseInt(document.getElementById('mealProtein').value) || 0;
  const entry = {
    type: document.getElementById('mealType').value,
    desc, calories: cal, protein,
    portion: document.getElementById('mealPortion').value,
    notes: document.getElementById('mealNotes').value.trim(),
    time: getTimestampFromInput('mealTime')
  };
  foodLog.push(entry);
  setStore('foodLog', foodLog);
  renderFood();
  closeModal('mealModal');
  pushUndo('addFood', entry);
  showToast('Meal logged!', true);
}

function renderFood() {
  const totalCal = foodLog.reduce((s, e) => s + (e.calories || 0), 0);
  const totalProtein = foodLog.reduce((s, e) => s + (e.protein || 0), 0);
  const meals = foodLog.filter(e => ['Breakfast','Lunch','Dinner'].includes(e.type)).length;
  const snacks = foodLog.filter(e => !['Breakfast','Lunch','Dinner'].includes(e.type)).length;

  // Update counts
  document.getElementById('calorieCount').textContent = totalCal;
  document.getElementById('proteinCount').textContent = totalProtein;
  document.getElementById('mealCount').textContent = meals;
  document.getElementById('snackCount').textContent = snacks;
  document.getElementById('foodEntryCount').textContent = foodLog.length + ' entries';

  // Update goal displays
  document.getElementById('calGoalDisplay').textContent = calorieGoal;
  document.getElementById('proteinGoalDisplay').textContent = proteinGoal;

  // Update progress bars
  const calPct = Math.min(totalCal / calorieGoal * 100, 100);
  const protPct = Math.min(totalProtein / proteinGoal * 100, 100);
  document.getElementById('calBar').style.width = calPct + '%';
  document.getElementById('proteinBar').style.width = protPct + '%';
  // Change bar color to green when goal is met
  document.getElementById('calBar').style.background = totalCal >= calorieGoal ? 'var(--success)' : 'var(--warning)';
  document.getElementById('proteinBar').style.background = totalProtein >= proteinGoal ? 'var(--success)' : 'var(--success)';

  // Build meal timeline
  const tlEl = document.getElementById('mealTimeline');
  if (foodLog.length === 0) {
    tlEl.innerHTML = '';
    document.getElementById('foodLog').innerHTML = '<div class="empty-state"><div class="icon">üçΩÔ∏è</div><p>No meals logged yet today.<br>Goal: ' + calorieGoal + ' cal & ' + proteinGoal + 'g protein</p></div>';
    return;
  }

  // Sort by time for timeline
  const sorted = foodLog.map((e, i) => ({...e, origIdx: i})).sort((a, b) => new Date(a.time) - new Date(b.time));

  let timelineHTML = '<div class="meal-timeline">';
  sorted.forEach((e, i) => {
    const t = new Date(e.time);
    const typeClass = e.type.toLowerCase().replace(/[^a-z]/g, '');
    const dotClass = ['breakfast','lunch','dinner'].includes(typeClass) ? typeClass : (typeClass === 'supplementdrink' ? 'supplement' : 'snack');

    // Check for large gaps (> 4 hours) between meals
    if (i > 0) {
      const prevTime = new Date(sorted[i-1].time);
      const gapHours = (t - prevTime) / (1000 * 60 * 60);
      if (gapHours >= 4) {
        timelineHTML += `<div class="tl-gap-warning"><span class="gap-label">‚ö†Ô∏è ${Math.round(gapHours)} hour gap</span></div>`;
      }
    }

    timelineHTML += `
      <div class="tl-item">
        <div class="tl-dot ${dotClass}"></div>
        <div>
          <span class="tl-time">${t.toLocaleTimeString([], {hour:'numeric',minute:'2-digit'})}</span>
          <span class="tl-type ${dotClass}">${e.type}</span>
          <div class="tl-desc">${e.desc}</div>
          <div class="tl-meta">${e.calories} cal ¬∑ ${e.protein}g protein ¬∑ Ate: ${e.portion}${e.notes ? ' ¬∑ ' + e.notes : ''}</div>
        </div>
      </div>`;
  });
  timelineHTML += '</div>';
  tlEl.innerHTML = timelineHTML;

  // Regular log (reverse chrono) with delete buttons
  const logEl = document.getElementById('foodLog');
  logEl.innerHTML = '<h3 style="font-size:14px;color:var(--gray-500);margin:12px 0 8px;border-top:1px solid var(--gray-200);padding-top:12px;">Edit Log</h3>' +
    foodLog.slice().reverse().map((e, i) => {
    const realIdx = foodLog.length - 1 - i;
    const t = new Date(e.time);
    return `<div class="log-entry">
      <div class="info">
        <div class="time">${t.toLocaleTimeString([], {hour:'numeric',minute:'2-digit'})} ¬∑ ${e.type}</div>
        <div class="detail">${e.desc}</div>
        <div class="sub">${e.calories} cal ¬∑ ${e.protein}g protein ¬∑ Ate: ${e.portion}</div>
      </div>
      <button class="delete-btn" onclick="deleteFood(${realIdx})">‚úï</button>
    </div>`;
  }).join('');
}

function deleteFood(idx) {
  foodLog.splice(idx, 1);
  setStore('foodLog', foodLog);
  renderFood();
}

// ==================== PHYSICAL THERAPY ====================
const EX_TYPE_ICONS = { Walk: 'üö∂', 'Prescribed Exercise': 'üè•', Stretch: 'üßò', Strength: 'üí™', Balance: '‚öñÔ∏è', Breathing: 'üå¨Ô∏è', Other: 'üìã' };

function renderExercises() {
  const done = exercises.filter(e => e.done).length;
  document.getElementById('ptProgress').textContent = `${done}/${exercises.length} completed`;

  const el = document.getElementById('exerciseList');
  el.innerHTML = exercises.map((ex, i) => `
    <div class="exercise-item ${ex.done ? 'completed' : ''}">
      <div class="exercise-check ${ex.done ? 'done' : ''}" onclick="toggleExercise(${i})">
        ${ex.done ? '‚úì' : ''}
      </div>
      <div class="exercise-info">
        <div class="exercise-name">${EX_TYPE_ICONS[ex.type] || 'üìã'} ${ex.name}</div>
        <div class="exercise-desc">${ex.desc}${ex.duration ? ' ¬∑ ' + ex.duration : ''}</div>
      </div>
      <button class="delete-btn" onclick="removeExercise(${i})" title="Remove">‚úï</button>
    </div>
  `).join('');

  document.getElementById('ptNotes').value = ptNotes.notes || '';
  document.querySelectorAll('#energyScale .severity-btn').forEach(b => {
    b.classList.toggle('selected', parseInt(b.dataset.level) === ptNotes.energy);
  });
}

function toggleExercise(idx) {
  const prevDone = exercises[idx].done;
  const prevCompletedAt = exercises[idx].completedAt;
  exercises[idx].done = !exercises[idx].done;
  if (exercises[idx].done) {
    exercises[idx].completedAt = selectedDate === REAL_TODAY ? new Date().toISOString() : new Date(selectedDate + 'T12:00:00').toISOString();
  }
  setStore('exercises', exercises);
  renderExercises();
  pushUndo('toggleExercise', { idx, prevDone, prevCompletedAt });
  const done = exercises.filter(e => e.done).length;
  if (done === exercises.length) showToast('üéâ All exercises complete! Great job!', true);
  else showToast(exercises[idx].done ? '‚úì Exercise completed!' : 'Exercise unchecked', true);
}

function openAddExercise() {
  document.getElementById('exerciseModal').classList.add('active');
  document.getElementById('exName').value = '';
  document.getElementById('exDesc').value = '';
  document.getElementById('exDuration').value = '';
  document.getElementById('exSaveGlobal').checked = true;
  updateExFields();
}

function updateExFields() {
  const type = document.getElementById('exType').value;
  if (type === 'Walk') {
    document.getElementById('exName').placeholder = 'e.g., Hallway walk, Outside walk';
    document.getElementById('exDesc').placeholder = 'e.g., Walk to nurses station and back with walker';
    document.getElementById('exDuration').placeholder = 'e.g., 5 minutes, 200 feet';
  } else if (type === 'Prescribed Exercise') {
    document.getElementById('exName').placeholder = 'e.g., Leg lifts, Arm raises';
    document.getElementById('exDesc').placeholder = 'e.g., Doctor/PT prescribed instructions';
    document.getElementById('exDuration').placeholder = 'e.g., 3 sets of 10';
  } else {
    document.getElementById('exName').placeholder = 'e.g., Exercise name';
    document.getElementById('exDesc').placeholder = 'Description or instructions';
    document.getElementById('exDuration').placeholder = 'e.g., 10 minutes, 3 sets of 10';
  }
}

function saveExercise() {
  const name = document.getElementById('exName').value.trim();
  if (!name) return showToast('Please enter an exercise name');
  const newEx = {
    id: Date.now(),
    name,
    desc: document.getElementById('exDesc').value.trim() || '',
    type: document.getElementById('exType').value,
    duration: document.getElementById('exDuration').value.trim() || '',
    done: false,
    completedAt: null
  };

  // Add to today's list
  exercises.push(newEx);
  setStore('exercises', exercises);

  // Optionally add to global library so it appears on future days
  if (document.getElementById('exSaveGlobal').checked) {
    const libEntry = {...newEx, done: undefined, completedAt: undefined};
    exerciseLibrary.push(libEntry);
    setGlobal('exerciseLibrary', exerciseLibrary);
  }

  renderExercises();
  closeModal('exerciseModal');
  pushUndo('addExercise', { id: newEx.id, addedToLibrary: document.getElementById('exSaveGlobal').checked });
  showToast(`${name} added!`, true);
}

function removeExercise(idx) {
  const ex = exercises[idx];
  if (!confirm(`Remove "${ex.name}" from today's exercises?`)) return;
  exercises.splice(idx, 1);
  setStore('exercises', exercises);

  // Ask if they want to remove from daily routine too
  const inLibrary = exerciseLibrary.findIndex(e => e.name === ex.name);
  if (inLibrary !== -1) {
    if (confirm(`Also remove "${ex.name}" from your daily routine?\n\n(It won't appear on future days)`)) {
      exerciseLibrary.splice(inLibrary, 1);
      setGlobal('exerciseLibrary', exerciseLibrary);
    }
  }
  renderExercises();
}

function savePTNotes() {
  ptNotes.notes = document.getElementById('ptNotes').value;
  setStore('ptNotes', ptNotes);
}

function setEnergy(level) {
  ptNotes.energy = level;
  setStore('ptNotes', ptNotes);
  renderExercises();
}

// ==================== MEDICATIONS ====================
function openAddMed() {
  document.getElementById('medModal').classList.add('active');
  document.getElementById('medName').value = '';
  document.getElementById('medDose').value = '';
  document.getElementById('medNotes').value = '';
}

function saveMed() {
  const name = document.getElementById('medName').value.trim();
  if (!name) return showToast('Please enter medication name');
  const newMed = {
    id: Date.now(),
    name,
    dose: document.getElementById('medDose').value.trim(),
    schedule: document.getElementById('medSchedule').value,
    notes: document.getElementById('medNotes').value.trim(),
    active: true
  };
  medications.push(newMed);
  setGlobal('medications', medications);
  renderMeds();
  closeModal('medModal');
  pushUndo('addMed', newMed);
  showToast('Medication added!', true);
}

function takeMed(medId) {
  const med = medications.find(m => m.id === medId);
  if (!med) return;
  const prevMedsTaken = JSON.parse(JSON.stringify(medsTaken)); // deep copy for undo
  const alreadyTaken = medsTaken.find(t => t.medId === medId);
  if (alreadyTaken) {
    medsTaken = medsTaken.filter(t => t.medId !== medId);
  } else {
    medsTaken.push({ medId, name: med.name, dose: med.dose, time: getTimestamp('meds') });
  }
  setStore('medsTaken', medsTaken);
  renderMeds();
  pushUndo('takeMed', { prevMedsTaken });
  showToast(alreadyTaken ? `${med.name} unmarked` : `${med.name} taken ‚úì`, true);
}

function discontinueMed(medId) {
  const med = medications.find(m => m.id === medId);
  if (!med) return;
  med.active = false;
  med.discontinuedDate = new Date().toISOString().split('T')[0];
  setGlobal('medications', medications);
  renderMeds();
  pushUndo('discontinueMed', { medId, name: med.name });
  showToast(`${med.name} removed`, true);
}

function reactivateMed(medId) {
  const med = medications.find(m => m.id === medId);
  if (!med) return;
  med.active = true;
  delete med.discontinuedDate;
  setGlobal('medications', medications);
  renderMeds();
  showToast(`${med.name} re-added!`);
}

function permanentlyDeleteMed(medId) {
  const med = medications.find(m => m.id === medId);
  if (!med) return;
  if (!confirm(`Permanently remove "${med.name}"?\n\nThis cannot be undone. The medication will be completely deleted from the app.`)) return;
  medications = medications.filter(m => m.id !== medId);
  setGlobal('medications', medications);
  renderMeds();
  showToast(`${med.name} permanently removed`);
}

function removeAllDiscontinued() {
  const discMeds = medications.filter(m => m.active === false);
  if (discMeds.length === 0) return;
  const names = discMeds.map(m => m.name).join(', ');
  if (!confirm(`Permanently remove ${discMeds.length} discontinued medication${discMeds.length > 1 ? 's' : ''}?\n\n${names}\n\nThis cannot be undone.`)) return;
  medications = medications.filter(m => m.active !== false);
  setGlobal('medications', medications);
  renderMeds();
  showToast(`${discMeds.length} medication${discMeds.length > 1 ? 's' : ''} permanently removed`);
}

function renderMeds() {
  const activeMeds = medications.filter(m => m.active !== false);
  const discontinuedMeds = medications.filter(m => m.active === false);
  const el = document.getElementById('medsList');
  const empty = document.getElementById('medsEmpty');
  const takenCount = activeMeds.filter(m => medsTaken.find(t => t.medId === m.id)).length;

  document.getElementById('medProgress').textContent = `${takenCount}/${activeMeds.length} taken today`;

  if (activeMeds.length === 0) {
    el.innerHTML = '';
    empty.style.display = 'block';
  } else {
    empty.style.display = 'none';
    el.innerHTML = activeMeds.map(m => {
      const taken = medsTaken.find(t => t.medId === m.id);
      return `<div class="med-item" style="${taken ? 'background:var(--success-light);border-color:var(--success);' : ''}">
        <div class="exercise-check ${taken ? 'done' : ''}" onclick="takeMed(${m.id})" style="cursor:pointer;">
          ${taken ? '‚úì' : ''}
        </div>
        <div class="med-info">
          <div class="med-name" style="${taken ? 'text-decoration:line-through;opacity:0.7;' : ''}">${m.name}</div>
          <div class="med-dose">${m.dose} ¬∑ ${m.schedule}${m.notes ? ' ¬∑ ' + m.notes : ''}${taken ? '<br><small style="color:var(--success)">Taken at ' + new Date(taken.time).toLocaleTimeString([], {hour:'numeric',minute:'2-digit'}) + '</small>' : ''}</div>
        </div>
        <button class="delete-btn" onclick="event.stopPropagation();discontinueMed(${m.id})" title="Remove" style="margin-left:4px;padding:8px 12px;font-size:20px;">‚úï</button>
      </div>`;
    }).join('');
  }

  // Discontinued meds section
  const discCard = document.getElementById('discontinuedCard');
  const discList = document.getElementById('discontinuedList');
  if (discontinuedMeds.length > 0) {
    discCard.style.display = 'block';
    discList.innerHTML = discontinuedMeds.map(m => `
      <div class="med-item" style="opacity:0.7;">
        <div class="med-info">
          <div class="med-name" style="text-decoration:line-through;">${m.name}</div>
          <div class="med-dose">${m.dose}${m.discontinuedDate ? ' \u00b7 Stopped ' + m.discontinuedDate : ''}</div>
        </div>
        <div style="display:flex;gap:6px;align-items:center;flex-shrink:0;">
          <button class="btn btn-sm btn-outline" onclick="reactivateMed(${m.id})" style="font-size:12px;">Re-add</button>
          <button class="delete-btn" onclick="event.stopPropagation();permanentlyDeleteMed(${m.id})" title="Permanently remove" style="padding:8px 10px;font-size:18px;color:var(--danger);">\u2715</button>
        </div>
      </div>
    `).join('') + `
      <div style="margin-top:12px;text-align:center;">
        <button class="btn btn-sm" onclick="removeAllDiscontinued()" style="background:var(--danger);color:white;font-size:12px;padding:8px 16px;">Remove All Discontinued</button>
      </div>`;
  } else {
    discCard.style.display = 'none';
  }

  // Med log
  const logEl = document.getElementById('medLog');
  if (medsTaken.length === 0) {
    logEl.innerHTML = '<div class="empty-state"><p style="font-size:13px">No medications taken yet today.</p></div>';
    return;
  }
  logEl.innerHTML = medsTaken.map(t => {
    const time = new Date(t.time);
    return `<div class="log-entry">
      <div class="info">
        <div class="time">${time.toLocaleTimeString([], {hour:'numeric',minute:'2-digit'})}</div>
        <div class="detail">${t.name}</div>
        <div class="sub">${t.dose}</div>
      </div>
    </div>`;
  }).join('');
}

// ==================== SYMPTOMS ====================
function toggleSymptom(el) {
  el.classList.toggle('selected');
  const sym = el.dataset.symptom;
  if (el.classList.contains('selected')) {
    selectedSymptoms.push(sym);
  } else {
    selectedSymptoms = selectedSymptoms.filter(s => s !== sym);
  }
}

function setSymptomSeverity(level) {
  currentSymptomSeverity = level;
  document.querySelectorAll('#symptomSeverity .severity-btn').forEach(b => {
    b.classList.toggle('selected', parseInt(b.dataset.level) === level);
  });
}

function logSymptom() {
  if (selectedSymptoms.length === 0) return showToast('Please select at least one symptom');
  if (currentSymptomSeverity === 0) return showToast('Please select severity');

  const entry = {
    symptoms: [...selectedSymptoms],
    severity: currentSymptomSeverity,
    notes: document.getElementById('symptomNotes').value.trim(),
    time: getTimestamp('symptoms'),
    loggedBy: caregiverMode ? 'Caregiver' : 'Patient'
  };
  symptomLog.push(entry);
  setStore('symptomLog', symptomLog);

  // Reset
  selectedSymptoms = [];
  currentSymptomSeverity = 0;
  document.querySelectorAll('.symptom-chip').forEach(c => c.classList.remove('selected'));
  document.querySelectorAll('#symptomSeverity .severity-btn').forEach(b => b.classList.remove('selected'));
  document.getElementById('symptomNotes').value = '';
  resetTimeOverride('symptoms');

  renderSymptoms();
  pushUndo('addSymptom', entry);
  showToast('Symptoms logged', true);
}

function renderSymptoms() {
  const logEl = document.getElementById('symptomLog');
  if (symptomLog.length === 0) {
    logEl.innerHTML = '<div class="empty-state"><p style="font-size:13px">No symptoms reported today. That\'s good!</p></div>';
    return;
  }
  logEl.innerHTML = symptomLog.slice().reverse().map((e, i) => {
    const realIdx = symptomLog.length - 1 - i;
    const t = new Date(e.time);
    const sevColors = ['','#22c55e','#84cc16','#eab308','#f97316','#ef4444'];
    return `<div class="log-entry">
      <div class="info">
        <div class="time">${t.toLocaleTimeString([], {hour:'numeric',minute:'2-digit'})}${e.loggedBy === 'Caregiver' ? ' ¬∑ üë§ Caregiver' : ''}</div>
        <div class="detail" style="color:${sevColors[e.severity]}">${e.symptoms.join(', ')} ‚Äî Severity ${e.severity}/5</div>
        ${e.notes ? `<div class="sub">${e.notes}</div>` : ''}
      </div>
      <button class="delete-btn" onclick="deleteSymptom(${realIdx})">‚úï</button>
    </div>`;
  }).join('');
}

function deleteSymptom(idx) {
  symptomLog.splice(idx, 1);
  setStore('symptomLog', symptomLog);
  renderSymptoms();
}

// ==================== SUMMARY ====================
function updateSummary() {
  // Calculate patient age
  const dob = new Date(1953, 3, 5); // April 5, 1953
  const now = new Date();
  let age = now.getFullYear() - dob.getFullYear();
  if (now.getMonth() < dob.getMonth() || (now.getMonth() === dob.getMonth() && now.getDate() < dob.getDate())) age--;
  const ageEl = document.getElementById('patientAge');
  if (ageEl) ageEl.textContent = age;

  const totalOz = waterLog.reduce((s, e) => s + e.oz, 0);
  const totalCal = foodLog.reduce((s, e) => s + (e.calories || 0), 0);
  const totalProtein = foodLog.reduce((s, e) => s + (e.protein || 0), 0);
  const donePT = exercises.filter(e => e.done).length;

  document.getElementById('sumWater').textContent = totalOz;
  document.getElementById('sumCalories').textContent = totalCal;
  document.getElementById('sumProtein').textContent = totalProtein + 'g';
  document.getElementById('sumCalGoal').textContent = calorieGoal;
  document.getElementById('sumProtGoal').textContent = proteinGoal;
  document.getElementById('sumExercises').textContent = `${donePT}/${exercises.length}`;

  // Hydration today
  const sumWaterEl = document.getElementById('sumWaterLog');
  if (waterLog.length === 0) {
    sumWaterEl.innerHTML = '<p style="font-size:13px;color:var(--gray-500)">No water logged</p>';
  } else {
    const sorted = waterLog.slice().sort((a, b) => new Date(a.time) - new Date(b.time));
    sumWaterEl.innerHTML = sorted.map(e => {
      const t = new Date(e.time);
      return `<div class="log-entry">
        <div class="info">
          <div class="time">${t.toLocaleTimeString([], {hour:'numeric',minute:'2-digit'})} ¬∑ ${e.type}</div>
          <div class="detail">${e.oz} oz</div>
        </div>
      </div>`;
    }).join('');
  }

  // Meals summary
  const mealsEl = document.getElementById('sumMeals');
  if (foodLog.length === 0) {
    mealsEl.innerHTML = '<p style="font-size:13px;color:var(--gray-500)">No meals logged</p>';
  } else {
    mealsEl.innerHTML = foodLog.map(e => {
      const t = new Date(e.time);
      return `<div class="log-entry">
        <div class="info">
          <div class="time">${t.toLocaleTimeString([], {hour:'numeric',minute:'2-digit'})} ¬∑ ${e.type}</div>
          <div class="detail">${e.desc}</div>
          <div class="sub">${e.calories} cal ¬∑ ${e.protein}g protein ¬∑ Ate: ${e.portion}</div>
        </div>
      </div>`;
    }).join('');
  }

  // Symptoms summary
  const symEl = document.getElementById('sumSymptoms');
  if (symptomLog.length === 0) {
    symEl.innerHTML = '<p style="font-size:13px;color:var(--gray-500)">No symptoms reported today</p>';
  } else {
    symEl.innerHTML = symptomLog.map(e => {
      const t = new Date(e.time);
      return `<div class="log-entry">
        <div class="info">
          <div class="time">${t.toLocaleTimeString([], {hour:'numeric',minute:'2-digit'})}</div>
          <div class="detail">${e.symptoms.join(', ')} ‚Äî Severity ${e.severity}/5</div>
          ${e.notes ? `<div class="sub">${e.notes}</div>` : ''}
        </div>
      </div>`;
    }).join('');
  }

  // Meds summary
  const medSumEl = document.getElementById('sumMeds');
  const activeMedsSummary = medications.filter(m => m.active !== false);
  const takenCount = activeMedsSummary.filter(m => medsTaken.find(t => t.medId === m.id)).length;
  const totalMeds = activeMedsSummary.length;
  if (totalMeds === 0) {
    medSumEl.innerHTML = '<p style="font-size:13px;color:var(--gray-500)">No medications configured</p>';
  } else {
    medSumEl.innerHTML = `<p style="font-size:14px;margin-bottom:8px;"><strong>${takenCount}/${totalMeds}</strong> medications taken</p>` +
      activeMedsSummary.map(m => {
        const taken = medsTaken.find(t => t.medId === m.id);
        return `<div class="log-entry">
          <div class="info">
            <div class="detail">${taken ? '‚úÖ' : '‚¨ú'} ${m.name}</div>
            <div class="sub">${m.dose} ¬∑ ${m.schedule}${taken ? ' ¬∑ Taken at ' + new Date(taken.time).toLocaleTimeString([], {hour:'numeric',minute:'2-digit'}) : ''}</div>
          </div>
        </div>`;
      }).join('');
  }
}

// ==================== REPORT ====================
function generateReport() {
  const totalOz = waterLog.reduce((s, e) => s + e.oz, 0);
  const totalCal = foodLog.reduce((s, e) => s + (e.calories || 0), 0);
  const totalProtein = foodLog.reduce((s, e) => s + (e.protein || 0), 0);
  const donePT = exercises.filter(e => e.done).length;

  let report = `DAILY HEALTH REPORT\n`;
  report += `Date: ${new Date().toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' })}\n`;
  report += `Patient: William Frank Barkwell\n`;
  const currentLbs = weightHistory.length > 0 ? weightHistory[weightHistory.length - 1].lbs : 152;
  report += `DOB: 04/05/1953 | Height: 5'11" | Weight: ${currentLbs} lbs\n`;
  report += `Dx: BMT Survivor | GVHD | Scleroderma | Orthostatic Hypotension\n`;
  report += `${'='.repeat(50)}\n\n`;

  report += `HYDRATION\n`;
  report += `Total: ${totalOz} oz (Goal: ${waterGoalOz} oz) ‚Äî ${Math.round(totalOz/waterGoalOz*100)}%\n`;
  waterLog.forEach(e => {
    report += `  ${new Date(e.time).toLocaleTimeString([], {hour:'numeric',minute:'2-digit'})} ‚Äî ${e.oz} oz ${e.type}\n`;
  });

  report += `\nNUTRITION\n`;
  report += `Total Calories: ${totalCal}/${calorieGoal} (${Math.round(totalCal/calorieGoal*100)}%) | Protein: ${totalProtein}g/${proteinGoal}g (${Math.round(totalProtein/proteinGoal*100)}%)\n`;
  foodLog.forEach(e => {
    report += `  ${new Date(e.time).toLocaleTimeString([], {hour:'numeric',minute:'2-digit'})} ‚Äî ${e.type}: ${e.desc} (${e.calories} cal, ${e.protein}g protein, Ate: ${e.portion})\n`;
    if (e.notes) report += `    Note: ${e.notes}\n`;
  });

  report += `\nPHYSICAL THERAPY (${donePT}/${exercises.length} completed)\n`;
  exercises.forEach(e => {
    report += `  ${e.done ? '‚úì' : '‚óã'} ${e.name}${e.done && e.completedAt ? ' ‚Äî ' + new Date(e.completedAt).toLocaleTimeString([], {hour:'numeric',minute:'2-digit'}) : ''}\n`;
  });
  if (ptNotes.energy) report += `Energy Level: ${ptNotes.energy}/5\n`;
  if (ptNotes.notes) report += `PT Notes: ${ptNotes.notes}\n`;

  const activeReportMeds = medications.filter(m => m.active !== false);
  report += `\nMEDICATIONS (${medsTaken.length}/${activeReportMeds.length} taken)\n`;
  activeReportMeds.forEach(m => {
    const taken = medsTaken.find(t => t.medId === m.id);
    report += `  ${taken ? '‚úì' : '‚óã'} ${m.name} (${m.dose}) ‚Äî ${m.schedule}${taken ? ' ‚Äî Taken ' + new Date(taken.time).toLocaleTimeString([], {hour:'numeric',minute:'2-digit'}) : ' ‚Äî NOT TAKEN'}\n`;
  });

  report += `\nSYMPTOMS (${symptomLog.length} reports)\n`;
  if (symptomLog.length === 0) {
    report += `  No symptoms reported\n`;
  } else {
    symptomLog.forEach(e => {
      report += `  ${new Date(e.time).toLocaleTimeString([], {hour:'numeric',minute:'2-digit'})} ‚Äî ${e.symptoms.join(', ')} (Severity: ${e.severity}/5)\n`;
      if (e.notes) report += `    Note: ${e.notes}\n`;
    });
  }

  report += `\n${'='.repeat(50)}\n`;
  report += `Report generated: ${new Date().toLocaleString()}\n`;

  // Copy to clipboard
  navigator.clipboard.writeText(report).then(() => {
    showToast('üìã Report copied to clipboard!');
  }).catch(() => {
    // Fallback
    document.getElementById('reportOutput').style.display = 'block';
    document.getElementById('reportText').textContent = report;
    showToast('Report generated ‚Äî see below');
  });

  document.getElementById('reportOutput').style.display = 'block';
  document.getElementById('reportText').textContent = report;
}

// ==================== WEIGHT TRACKING ====================
function openUpdateWeight() {
  document.getElementById('weightModal').classList.add('active');
  const current = weightHistory.length > 0 ? weightHistory[weightHistory.length - 1].lbs : 152;
  document.getElementById('newWeight').value = current;
  document.getElementById('weightNotes').value = '';
  renderWeightHistory();
}

function saveWeight() {
  const lbs = parseFloat(document.getElementById('newWeight').value);
  if (!lbs || lbs <= 0) return showToast('Please enter a valid weight');
  const entry = {
    lbs,
    date: selectedDate,
    time: new Date().toISOString(),
    notes: document.getElementById('weightNotes').value.trim()
  };
  weightHistory.push(entry);
  setGlobal('weightHistory', weightHistory);
  closeModal('weightModal');
  updateWeightDisplay();
  pushUndo('addWeight', entry);
  showToast(`Weight updated to ${lbs} lbs`, true);
}

function updateWeightDisplay() {
  if (weightHistory.length === 0) return;
  const current = weightHistory[weightHistory.length - 1];
  document.getElementById('currentWeight').textContent = current.lbs + ' lbs';

  // Show trend
  const trendEl = document.getElementById('weightTrend');
  if (weightHistory.length >= 2) {
    const prev = weightHistory[weightHistory.length - 2];
    const diff = current.lbs - prev.lbs;
    const arrow = diff > 0 ? '‚Üë' : diff < 0 ? '‚Üì' : '‚Üí';
    const color = diff > 0 ? 'var(--success)' : diff < 0 ? 'var(--danger)' : 'var(--gray-500)';
    const absDiff = Math.abs(diff).toFixed(1);
    trendEl.innerHTML = `<span style="color:${color};font-weight:600;">${arrow} ${absDiff} lbs</span> since last weigh-in (${prev.date})`;
  } else {
    trendEl.textContent = '';
  }
}

function renderWeightHistory() {
  const el = document.getElementById('weightHistory');
  if (weightHistory.length === 0) {
    el.innerHTML = '';
    return;
  }
  el.innerHTML = '<h3 style="font-size:14px;color:var(--gray-500);margin-bottom:8px;border-top:1px solid var(--gray-200);padding-top:12px;">Weight History</h3>' +
    weightHistory.slice().reverse().map(e => {
      const d = new Date(e.time);
      return `<div class="log-entry">
        <div class="info">
          <div class="time">${e.date} ¬∑ ${d.toLocaleTimeString([], {hour:'numeric',minute:'2-digit'})}</div>
          <div class="detail">${e.lbs} lbs</div>
          ${e.notes ? `<div class="sub">${e.notes}</div>` : ''}
        </div>
      </div>`;
    }).join('');
}

// ==================== EXPORT / IMPORT ====================
function getAllStorageData() {
  const data = {
    exportDate: new Date().toISOString(),
    appVersion: '1.0',
    global: {
      medications: getGlobal('medications', []),
      exerciseLibrary: getGlobal('exerciseLibrary', []),
      caregiverMode: getGlobal('caregiverMode', false),
      waterGoalOz: getGlobal('waterGoalOz', 76),
      calorieGoal: getGlobal('calorieGoal', 2000),
      proteinGoal: getGlobal('proteinGoal', 90),
      weightHistory: getGlobal('weightHistory', [])
    },
    days: {}
  };

  // Scan localStorage for all date-keyed entries
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    const dateMatch = key.match(/^(.+)_(\d{4}-\d{2}-\d{2})$/);
    if (dateMatch) {
      const [, dataKey, date] = dateMatch;
      if (!data.days[date]) data.days[date] = {};
      try {
        data.days[date][dataKey] = JSON.parse(localStorage.getItem(key));
      } catch {}
    }
  }

  return data;
}


function exportAllData() {
  const data = getAllStorageData();
  const dayCount = Object.keys(data.days).length;
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `health-tracker-export-${REAL_TODAY}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast(`Exported ${dayCount} day(s) of data`);
}

function exportTodayData() {
  const data = {
    exportDate: new Date().toISOString(),
    appVersion: '1.0',
    global: {
      medications: getGlobal('medications', []),
      exerciseLibrary: getGlobal('exerciseLibrary', []),
      caregiverMode: getGlobal('caregiverMode', false),
      waterGoalOz: getGlobal('waterGoalOz', 76),
      calorieGoal: getGlobal('calorieGoal', 2000),
      proteinGoal: getGlobal('proteinGoal', 90),
      weightHistory: getGlobal('weightHistory', [])
    },
    days: {}
  };
  data.days[selectedDate] = {
    waterLog, foodLog, exercises, ptNotes, medsTaken, symptomLog
  };

  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `health-tracker-${selectedDate}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast(`Exported data for ${selectedDate}`);
}

function exportAsCSV() {
  let csv = 'Date,Time,Category,Type,Description,Amount,Calories,Protein,Severity,Notes\n';

  // Gather all days
  const data = getAllStorageData();
  const dates = Object.keys(data.days).sort();

  dates.forEach(date => {
    const day = data.days[date];

    // Water
    if (day.waterLog) {
      day.waterLog.forEach(e => {
        const time = new Date(e.time).toLocaleTimeString([], {hour:'numeric',minute:'2-digit'});
        csv += `${date},${time},Water,${e.type},,${e.oz} oz,,,,""\n`;
      });
    }

    // Food
    if (day.foodLog) {
      day.foodLog.forEach(e => {
        const time = new Date(e.time).toLocaleTimeString([], {hour:'numeric',minute:'2-digit'});
        const desc = (e.desc || '').replace(/"/g, '""');
        const notes = (e.notes || '').replace(/"/g, '""');
        csv += `${date},${time},Food,${e.type},"${desc}",,${e.calories},${e.protein},,"${notes}"\n`;
      });
    }

    // Exercises
    if (day.exercises) {
      day.exercises.forEach(e => {
        const time = e.completedAt ? new Date(e.completedAt).toLocaleTimeString([], {hour:'numeric',minute:'2-digit'}) : '';
        csv += `${date},${time},Exercise,${e.type || ''},"${e.name}",${e.done ? 'Completed' : 'Incomplete'},,,,\n`;
      });
    }

    // Meds
    if (day.medsTaken) {
      day.medsTaken.forEach(e => {
        const time = new Date(e.time).toLocaleTimeString([], {hour:'numeric',minute:'2-digit'});
        csv += `${date},${time},Medication,Taken,"${e.name}","${e.dose}",,,,\n`;
      });
    }

    // Symptoms
    if (day.symptomLog) {
      day.symptomLog.forEach(e => {
        const time = new Date(e.time).toLocaleTimeString([], {hour:'numeric',minute:'2-digit'});
        const syms = e.symptoms.join('; ');
        const notes = (e.notes || '').replace(/"/g, '""');
        csv += `${date},${time},Symptom,,"${syms}",,,,${e.severity},"${notes}"\n`;
      });
    }
  });

  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `health-tracker-export-${REAL_TODAY}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast(`CSV exported with ${dates.length} day(s) of data`);
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const statusEl = document.getElementById('importStatus');

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);

      if (!data.global && !data.days) {
        statusEl.style.display = 'block';
        statusEl.style.background = 'var(--danger-light)';
        statusEl.style.color = 'var(--danger)';
        statusEl.textContent = 'Invalid file format. Please use a file exported from this app.';
        return;
      }

      let dayCount = 0;

      // Import global settings
      if (data.global) {
        if (data.global.medications) setGlobal('medications', data.global.medications);
        if (data.global.exerciseLibrary) setGlobal('exerciseLibrary', data.global.exerciseLibrary);
        if (data.global.caregiverMode !== undefined) setGlobal('caregiverMode', data.global.caregiverMode);
        if (data.global.waterGoalOz) setGlobal('waterGoalOz', data.global.waterGoalOz);
        if (data.global.calorieGoal) setGlobal('calorieGoal', data.global.calorieGoal);
        if (data.global.proteinGoal) setGlobal('proteinGoal', data.global.proteinGoal);
        if (data.global.weightHistory) setGlobal('weightHistory', data.global.weightHistory);
      }

      // Import day data
      if (data.days) {
        Object.keys(data.days).forEach(date => {
          const day = data.days[date];
          Object.keys(day).forEach(key => {
            try {
              localStorage.setItem(key + '_' + date, JSON.stringify(day[key]));
            } catch {}
          });
          dayCount++;
        });
      }

      // Reload everything
      medications = getGlobal('medications', []);
      exerciseLibrary = getGlobal('exerciseLibrary', []);
      caregiverMode = getGlobal('caregiverMode', false);
      waterGoalOz = getGlobal('waterGoalOz', 76);
      calorieGoal = getGlobal('calorieGoal', 2000);
      proteinGoal = getGlobal('proteinGoal', 90);
      weightHistory = getGlobal('weightHistory', []);
      reloadData();
      updateWeightDisplay();

      statusEl.style.display = 'block';
      statusEl.style.background = 'var(--success-light)';
      statusEl.style.color = 'var(--success)';
      statusEl.textContent = `Successfully imported ${dayCount} day(s) of data plus settings. All data restored!`;
      showToast(`Imported ${dayCount} day(s) of data!`);

    } catch (err) {
      statusEl.style.display = 'block';
      statusEl.style.background = 'var(--danger-light)';
      statusEl.style.color = 'var(--danger)';
      statusEl.textContent = 'Error reading file: ' + err.message;
    }
  };
  reader.readAsText(file);
  event.target.value = ''; // reset file input
}

// ==================== INIT ====================
init();
</script>
</body>
</html>
